<!DOCTYPE html><html lang="zh-Hans"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> Android-CustomView onMeasure · dangxy99的Blog</title><meta name="description" content="Android-CustomView onMeasure - dangxy"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.jpg"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="http://yoursite.com/atom.xml" title="dangxy99的Blog"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.jpg" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="/about/" target="_self" class="nav-list-link">ABOUT</a></li><li class="nav-list-item"><a href="https://github.com/dangxy" target="_blank" class="nav-list-link">GITHUB</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">Android-CustomView onMeasure</h1><div class="post-info">Jul 23, 2019</div><div class="post-content"><h3 id="onMeasure"><a href="#onMeasure" class="headerlink" title="onMeasure"></a>onMeasure</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onMeasure</span><span class="params">(<span class="keyword">int</span> widthMeasureSpec, <span class="keyword">int</span> heightMeasureSpec)</span></span></div></pre></td></tr></table></figure>
<a id="more"></a>
<h3 id="MeasureSpec"><a href="#MeasureSpec" class="headerlink" title="MeasureSpec"></a>MeasureSpec</h3><p>虽然表面上看起来他们是int类型的数字，其实他们是由mode+size两部分组成的。<br>widthMeasureSpec和heightMeasureSpec转化成二进制数字表示，他们都是32位的。前两位代表mode(测量模式)，后面30位才是他们的实际数值（size）。<br>MeasureSpec的值由specSize和specMode共同组成的，其中specSize记录的是大小，specMode记录的是规格。</p>
<ul>
<li>模式分类<br>它有三种模式： </li>
</ul>
<ol>
<li>UNSPECIFIED(未指定)，父元素部队自元素施加任何束缚，子元素可以得到任意想要的大小；<br>表示父视图希望子视图的大小应该是由specSize的值来决定的，系统默认会按照这个规则来设置子视图的大小，开发人员当然也可以按照自己的意愿设置成任意的大小。</li>
<li>EXACTLY(完全)，父元素决定自元素的确切大小，子元素将被限定在给定的边界里而忽略它本身大小； </li>
<li>AT_MOST(至多)，子元素至多达到指定大小的值。<br>他们对应的二进制值分别是：<br>UNSPECIFIED=00000000000000000000000000000000<br>EXACTLY = 01000000000000000000000000000000<br>AT_MOST =10000000000000000000000000000000<br>由于最前面两位代表模式，所以他们分别对应十进制的0，1，2； </li>
</ol>
<ul>
<li>模式提取<br>现在我们知道了widthMeasureSpec和heightMeasureSpec是由模式和数值组成的，而且二进制的前两位代表模式，后28位代表数字。<br>我们先想想，如果我们自己来提取widthMeasureSpec和heightMeasureSpec中的模式和数值是怎么提取呢？<br>首先想到的肯定是通过MASK和与运算去掉不需要的部分而得到对应的模式或数值。<br>说到这大家可能会迷茫，我们写段代码来提取模式部分吧：<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//对应11000000000000000000000000000000;总共32位，前两位是1  </span></div><div class="line"><span class="keyword">int</span> MODE_MASK  = <span class="number">0xc0000000</span>;   </div><div class="line"><span class="comment">//提取模式  </span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">getMode</span><span class="params">(<span class="keyword">int</span> measureSpec)</span> </span>&#123;  </div><div class="line">    <span class="keyword">return</span> (measureSpec &amp; MODE_MASK);  </div><div class="line">&#125;  </div><div class="line"><span class="comment">//提取数值  </span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">getSize</span><span class="params">(<span class="keyword">int</span> measureSpec)</span> </span>&#123;  </div><div class="line">    <span class="keyword">return</span> (measureSpec &amp; ~MODE_MASK);</div></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h3><p>测量View大小使用的是onMeasure函数，我们可以从onMeasure的两个参数中取出宽高的相关数据：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onMeasure</span><span class="params">(<span class="keyword">int</span> widthMeasureSpec, <span class="keyword">int</span> heightMeasureSpec)</span> </span>&#123;</div><div class="line">    <span class="keyword">int</span> widthsize  MeasureSpec.getSize(widthMeasureSpec);      <span class="comment">//取出宽度的确切数值</span></div><div class="line">    <span class="keyword">int</span> widthmode  MeasureSpec.getMode(widthMeasureSpec);      <span class="comment">//取出宽度的测量模式</span></div><div class="line">    </div><div class="line">    <span class="keyword">int</span> heightsize  MeasureSpec.getSize(heightMeasureSpec);    <span class="comment">//取出高度的确切数值</span></div><div class="line">    <span class="keyword">int</span> heightmode  MeasureSpec.getMode(heightMeasureSpec);    <span class="comment">//取出高度的测量模式</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="测量模式"><a href="#测量模式" class="headerlink" title="测量模式"></a>测量模式</h3><p>一共有三种， 被定义在 Android 中的 View 类的一个内部类View.MeasureSpec中：<br>模式          二进制数值        描述<br>UNSPECIFIED    00    默认值，父控件没有给子view任何限制，子View可以设置为任意大小。<br>EXACTLY    01    表示父控件已经确切的指定了子View的大小。<br>AT_MOST    10    表示子View具体大小没有尺寸限制，但是存在上限，上限一般为父View大小。<br>wrap_content-&gt; MeasureSpec.AT_MOST<br>match_parent -&gt; MeasureSpec.EXACTLY<br>具体值 -&gt; MeasureSpec.EXACTLY</p>
<h3 id="确定View的大小"><a href="#确定View的大小" class="headerlink" title="确定View的大小"></a>确定View的大小</h3><p>确定View大小(onSizeChanged)<br>这个函数在视图大小发生改变时调用。<br>Q: 在测量完View并使用setMeasuredDimension函数之后View的大小基本上已经确定了，那么为什么还要再次确定View的大小呢？<br>A: 这是因为View的大小不仅由View本身控制，而且受父控件的影响，所以我们在确定View大小的时候最好使用系统提供的onSizeChanged回调函数。<br>onSizeChanged如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onSizeChanged</span><span class="params">(<span class="keyword">int</span> w, <span class="keyword">int</span> h, <span class="keyword">int</span> oldw, <span class="keyword">int</span> oldh)</span> </span>&#123;</div><div class="line">    <span class="keyword">super</span>.onSizeChanged(w, h, oldw, oldh);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>可以看出，它又四个参数，分别为 宽度，高度，上一次宽度，上一次高度。<br>这个函数比较简单，我们只需关注 宽度(w), 高度(h) 即可，这两个参数就是View最终的大小。</p>
<h3 id="调用父类的onMeasure"><a href="#调用父类的onMeasure" class="headerlink" title="调用父类的onMeasure()"></a>调用父类的onMeasure()</h3><p>首先定义一个类继承View，重写onMeasure()，并调用父类onMeasure()方法。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MeasureExampleView</span> <span class="keyword">extends</span> <span class="title">View</span> </span>&#123; </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MeasureExampleView</span><span class="params">(Context context)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>(context);</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MeasureExampleView</span><span class="params">(Context context, AttributeSet attrs)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>(context, attrs);</div><div class="line">    &#125;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onMeasure</span><span class="params">(<span class="keyword">int</span> widthMeasureSpec, <span class="keyword">int</span> heightMeasureSpec)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.onMeasure(widthMeasureSpec, heightMeasureSpec);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>重写onMeasure()，并调用父类onMeasure()时</p>
<ul>
<li>MeasureExampleView的layout_width以及layout_height属性值 match_parent 或者 wrap_content显示大小由其父容器控件决定。</li>
<li>MeasureExampleView设置为固定的值，就显示该设定的值<h3 id="怎么样重写onMesure"><a href="#怎么样重写onMesure" class="headerlink" title="怎么样重写onMesure"></a>怎么样重写onMesure</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//widthMeasureSpec 和 heightMeasureSpec的值 由父容器决定</span></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onMeasure</span><span class="params">(<span class="keyword">int</span> widthMeasureSpec, <span class="keyword">int</span> heightMeasureSpec)</span> </span>&#123;</div><div class="line">    <span class="keyword">int</span> width  = measureDimension(DEFAULT_WIDTH, widthMeasureSpec);</div><div class="line">    <span class="keyword">int</span> height = measureDimension(DEFAULT_HEIGHT, heightMeasureSpec);</div><div class="line">    setMeasuredDimension(width, height);</div><div class="line">&#125;</div><div class="line">MeasureSpec.getSize()会解析MeasureSpec值得到父容器width或者height。</div><div class="line"></div><div class="line">MeasureSpec.getMode()会得到三个<span class="keyword">int</span>类型的值分别为:MeasureSpec.EXACTLY MeasureSpec.AT_MOST,MeasureSpec.UNSPECIFIED。</div><div class="line"></div><div class="line">MeasureSpec.UNSPECIFIED 未指定，所以可以设置任意大小。</div></pre></td></tr></table></figure>
</li>
</ul>
<ol>
<li>MeasureSpec.getSize()会解析MeasureSpec值得到父容器width或者height。</li>
<li>MeasureSpec.getMode()会得到三个int类型的值分别为:MeasureSpec.EXACTLY MeasureSpec.AT_MOST,MeasureSpec.UNSPECIFIED。<br>MeasureSpec.UNSPECIFIED 未指定，所以可以设置任意大小。<br>MeasureSpec.AT_MOST  MeasureExampleView可以为任意大小，但是有一个上限。比如这种情况<h3 id="重写onMeasure-函数"><a href="#重写onMeasure-函数" class="headerlink" title="重写onMeasure()函数"></a>重写onMeasure()函数</h3>我们前面讲过，onMeasure()的作用就是根据container内部的子控件计算自己的宽和高，最后通过setMeasuredDimension（int width,int height设置进去）；</li>
</ol>
</div></article></div></main><footer><div class="paginator"><a href="/2019/09/11/Android-图片加载库Glide/" class="prev">上一篇</a><a href="/2019/06/12/Android-CustomView-Canvas/" class="next">下一篇</a></div><div class="copyright"><p>© 2015 - 2020 <a href="http://yoursite.com">dangxy</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-65933410-1",'auto');ga('send','pageview');</script></body></html>